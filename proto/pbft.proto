syntax = "proto3";

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

package pb;
option go_package = "pbft-bank-application/proto;pb";

message Transaction {
  string from_client_id = 1;
  string to_client_id = 2;
  int32 amount = 3;
  int32 time = 4;
}

message PrePrepareMessageRequest {
  int32  view_number = 1;
  int32  sequence_number = 2;
  string digest = 3;
  int32  replica_id = 4;
  Transaction  transaction = 5;
  bytes  signature = 6;
}

// can think of better response
message PrePrepareMessageResponse {
  int32  view_number = 1;
  int32  sequence_number = 2;
  string digest = 3;
  int32  replica_id = 4;
  bytes  signature = 5;
  // shld always be PRE-PREPARED
  string status = 6;
}

message PrepareMessageRequest {
  repeated PrePrepareMessageResponse pre_prepared_message_response = 1;
  // are below fields needed?
  int32  replica_id = 2;
  bytes  signature = 3;
  int32 sequence_number = 4;
}

// can think of better response
message PrepareMessageResponse {
  int32  view_number = 1;
  int32  sequence_number = 2;
  string digest = 3;
  int32  replica_id = 4;
  bytes  signature = 5;
  // shld always be PREPARED
  string status = 6;
}

message CommitMessageRequest {
  repeated PrepareMessageResponse prepared_message_response = 1;
  // are below fields needed?
  int32  replica_id = 2;
  bytes  signature = 3;
  int32 sequence_number = 4;
}

message CommitMessageResponse {
  int32  view_number = 1;
  int32  sequence_number = 2;
  string digest = 3;
  int32  replica_id = 4;
  bytes  signature = 5;
  // shld be COMMITTED/EXECUTED
  string status = 6;
}

message ClientRequestMessage {
  string  client_id = 1;
  Transaction transaction = 2;
  bytes  client_sig = 3;
  repeated string live_nodes = 4;
  repeated string byzantine_nodes = 5;
}

message ReplyToClientRequest {
  int32  view = 1;
  int32  time = 2;
  bool result = 3;
  int32  replica_id = 4;
  bytes  signature = 5;
}

message Ack {
  bool success = 1;
  string message = 2;
}

message ReadClientBalanceRequest {
  string client_id = 1;
  bytes signature = 2;
}

message ReadClientBalanceResponse {
  int32 balance = 1;
  bytes  signature = 2;
}

message PrintDBResponse {
  int32 replica_id = 1;
  map<string, int32> balances = 2;
  int32 view_number = 3;
  int32 last_executed_seq = 4;
}

message Attack {
  string name = 1;
  repeated int32 nodes = 2;
}

message FlushAndUpdateStatusRequest {
   repeated int32 live_nodes = 1;
   repeated int32 byzantine_nodes = 2;
   repeated Attack attacks = 3;
}


// --------VIEW CHANGE / NEW VIEW----------------
message ViewChangeMessage {
  int32 new_view_number = 1;
  int32 node_id = 2;
  repeated PreparedProofSet prepared_proof_set = 3;
  bytes signature = 4;
}

message PreparedProofSet {
  int32 sequence_number = 1;
  int32 view_number = 2;
  string digest = 3;
  repeated StatusProof proofs = 4;
  string status = 5; // current status of the transaction in this node while sending view change message
  Transaction transaction = 6;
}

message StatusProof {
  int32 node_id = 1;
  int32 view = 2;
  int32 sequence_number = 3;
  string digest = 4;
  string status = 5;
  bytes signature = 6;
}

message NewViewMessage {
  int32 new_view_number = 1;
  int32 source_id = 2;
  repeated PrePrepareMessageRequest pre_prepares = 3;
  repeated ViewChangeMessage view_changes = 4;
  bytes signature = 5;
}

message PrintStatusRequest {
  int32 sequence_number = 1;
}

message PrintStatusResponse {
  int32 node_id = 1;
  int32 sequence_number = 2;
  string status = 3;
  Transaction transaction = 4;
}

message PrintViewRequest {
  int32 node_id=1;
}

message PrintViewResponse {
  map<int32, NewViewMessage> newViewNumberToNewViewMessageMap = 1;
}

message PrintLogRequest {
  int32 node_id=1;
}

message PrintLogEntry {
  string message_type = 1;
  int32 sequence_num = 2;
  int32 from_node_id =3;
  int32 to_node_id  =4;
  string direction =5;
  int32 view_number  =6;
  google.protobuf.Timestamp timestamp = 7;
}

message CheckPointMessageProof {
  repeated CheckpointMessageRequest checkpoint_message_requests = 1;
}

message PrintLogResponse {
  repeated PrintLogEntry print_log_entries = 1;
}

message StatusProofList {
  repeated StatusProof proofs = 1;
}

message LogEntryMessage {
  string digest = 1;
  int32 view_number = 2;
  int32 sequence_number = 3;
  string status = 4;
  Transaction transaction = 5;
  map<int32, StatusProofList> prepared_proof = 6;
  map<int32, StatusProofList> committed_proof = 7;
}

message PrintLogEntriesResponse {
  repeated LogEntryMessage log_entries = 1;
  int32 last_checkpointed_sequence_number = 2;
  map<int32, CheckPointMessageProof> checkPointMessageProofs = 3;
}

message CheckpointMessageRequest {
  int32 sequence_number = 1;
  string digest = 2;
  int32 replica_id = 3;
  bytes signature = 4;
}

message CheckpointMessageResponse {

}

service PBFTReplica {
  rpc SendRequestToLeader     (ClientRequestMessage)     returns (ReplyToClientRequest);
  rpc SendPrePrepare  (PrePrepareMessageRequest)  returns (PrePrepareMessageResponse);
  rpc SendPrepare     (PrepareMessageRequest)     returns (PrepareMessageResponse);
  rpc SendCommit      (CommitMessageRequest)      returns (CommitMessageResponse);
  rpc ReadClientBalance (ReadClientBalanceRequest) returns (ReadClientBalanceResponse);
  rpc FlushPreviousDataAndUpdatePeersStatus   (FlushAndUpdateStatusRequest) returns (google.protobuf.Empty);

  //View Change/New View RPCs:
  rpc SendViewChange (ViewChangeMessage) returns (google.protobuf.Empty);
  rpc SendNewView (NewViewMessage) returns (google.protobuf.Empty);

  //Checkpoint
  rpc SendCheckPointMessage(CheckpointMessageRequest) returns (CheckpointMessageResponse);

  // Client funcns
  rpc PrintDB                 (google.protobuf.Empty)     returns (PrintDBResponse);
  rpc PrintStatus (PrintStatusRequest) returns (PrintStatusResponse);
  rpc PrintView (PrintViewRequest) returns (PrintViewResponse);
  rpc PrintLog(PrintLogRequest) returns (PrintLogResponse);
  rpc PrintLogEntries(PrintLogRequest) returns (PrintLogEntriesResponse);
}

service ClientCallback {
  rpc ReplyToClientFromNode (ReplyToClientRequest) returns (Ack);
}
